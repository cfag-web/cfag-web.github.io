<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Manage Events | Admin</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="assets/css/admin.css">
</head>
<body class="admin-body">
<header class="admin-header">
    <div class="container">
        <div class="admin-header-inner">
            <div class="admin-logo">
                <a href="index.html">CFAG Admin</a>
            </div>
            <nav class="admin-nav">
                <a href="index.html">Dashboard</a>
                <a href="events.html" class="active">Events</a>
                <a href="sermons.html">Sermons</a>
                <a href="ministries.html">Ministries</a>
                <a href="gallery.html">Gallery</a>
                <a href="../index.html" target="_blank">View Site</a>
                <a href="logout.html">Logout</a>
            </nav>
        </div>
    </div>
</header>
<main class="admin-main">
    <div class="container">

<h1>Manage Events</h1>

<div id="admin-message" class="alert hidden" style="display: none;"></div>

<section class="admin-form-section" id="event-form-section" style="display: none;">
    <h2 id="form-title">Add New Event</h2>
    <form id="event-form" class="form">
        <input type="hidden" name="action" id="form-action" value="add">
        <input type="hidden" name="id" id="form-id">
        
        <div class="form-row">
            <label for="title">Event Title *</label>
            <input type="text" id="title" name="title" required>
        </div>
        
        <div class="form-row">
            <label for="date">Date *</label>
            <div class="date-input-wrapper">
                <input type="date" id="date" name="date" required>
                <span class="date-icon">ðŸ“…</span>
            </div>
        </div>
        
        <div class="form-row">
            <label for="time">Time *</label>
            <input type="text" id="time" name="time" placeholder="e.g., 10:00 AM" required>
        </div>
        
        <div class="form-row">
            <label for="location">Location *</label>
            <input type="text" id="location" name="location" required>
        </div>
        
        <div class="form-row">
            <label for="description">Description *</label>
            <textarea id="description" name="description" rows="4" required></textarea>
        </div>
        
        <div class="form-row">
            <button type="submit" class="btn btn-primary" id="submit-btn">Add Event</button>
            <a href="events.html" class="btn btn-outline">Cancel</a>
        </div>
    </form>
</section>

<div class="admin-actions-bar" id="actions-bar">
    <a href="events.html?action=add" class="btn btn-primary">âž• Add New Event</a>
</div>

<section class="admin-section">
    <h2>All Events (<span id="events-count">0</span>)</h2>
    
    <div id="no-events-message" style="display: none;">
        <p>No events yet. <a href="events.html?action=add">Add your first event</a>.</p>
    </div>
    
    <table class="admin-table" id="events-table" style="display: none;">
        <thead>
            <tr>
                <th>Title</th>
                <th>Date</th>
                <th>Time</th>
                <th>Location</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="events-tbody">
        </tbody>
    </table>
</section>

    </div>
</main>
<script src="../assets/js/main.js"></script>
<script src="assets/js/admin.js"></script>
<script>
    // Check authentication
    if (localStorage.getItem('admin_logged_in') !== 'true') {
        window.location.href = 'login.html';
    }

    function loadData(type) {
        const stored = localStorage.getItem('admin_' + type);
        if (stored) {
            return JSON.parse(stored);
        }
        const defaults = {
            events: [
                {"title": "Sunday Worship Service", "date": "2026-02-08", "time": "10:00 AM", "location": "Main Sanctuary", "description": "Join us for worship, teaching, and fellowship.", "id": "698577e1ea94d"},
                {"title": "Midweek Prayer Meeting", "date": "2026-02-05", "time": "7:00 PM", "location": "Prayer Room", "description": "A weekly time of corporate prayer and encouragement.", "id": "698577e1eacda"},
                {"title": "Youth Night", "date": "2026-02-15", "time": "6:30 PM", "location": "Youth Hall", "description": "Games, worship, and a timely message for students.", "id": "698577e1eaceb"}
            ]
        };
        return defaults[type] || [];
    }

    function saveData(type, data) {
        localStorage.setItem('admin_' + type, JSON.stringify(data));
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function showMessage(text, type) {
        const msgDiv = document.getElementById('admin-message');
        msgDiv.textContent = text;
        msgDiv.className = 'alert ' + type;
        msgDiv.style.display = 'block';
        setTimeout(() => {
            msgDiv.style.display = 'none';
        }, 5000);
    }

    function renderEvents() {
        const events = loadData('events');
        events.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        document.getElementById('events-count').textContent = events.length;
        
        const tbody = document.getElementById('events-tbody');
        tbody.innerHTML = '';
        
        if (events.length === 0) {
            document.getElementById('no-events-message').style.display = 'block';
            document.getElementById('events-table').style.display = 'none';
        } else {
            document.getElementById('no-events-message').style.display = 'none';
            document.getElementById('events-table').style.display = 'table';
            
            events.forEach(event => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${escapeHtml(event.title)}</strong></td>
                    <td>${escapeHtml(event.date || '')}</td>
                    <td>${escapeHtml(event.time || '')}</td>
                    <td>${escapeHtml(event.location || '')}</td>
                    <td class="admin-actions-cell">
                        <a href="events.html?action=edit&id=${escapeHtml(event.id)}" class="btn btn-outline btn-small">Edit</a>
                        <a href="#" class="btn btn-outline btn-small btn-danger" onclick="deleteEvent('${escapeHtml(event.id)}')">Delete</a>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    function deleteEvent(id) {
        if (!confirm('Are you sure you want to delete this event?')) {
            return;
        }
        
        const events = loadData('events');
        const filtered = events.filter(e => e.id !== id);
        saveData('events', filtered);
        showMessage('Event deleted successfully!', 'success');
        renderEvents();
    }

    window.deleteEvent = deleteEvent;

    // Handle URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const action = urlParams.get('action');
    const id = urlParams.get('id');

    if (action === 'add' || (action === 'edit' && id)) {
        document.getElementById('event-form-section').style.display = 'block';
        document.getElementById('actions-bar').style.display = 'none';
        
        if (action === 'edit' && id) {
            const events = loadData('events');
            const event = events.find(e => e.id === id);
            if (event) {
                document.getElementById('form-title').textContent = 'Edit Event';
                document.getElementById('form-action').value = 'edit';
                document.getElementById('form-id').value = event.id;
                document.getElementById('title').value = event.title || '';
                document.getElementById('date').value = event.date || '';
                document.getElementById('time').value = event.time || '';
                document.getElementById('location').value = event.location || '';
                document.getElementById('description').value = event.description || '';
                document.getElementById('submit-btn').textContent = 'Update Event';
            }
        }
    }

    // Handle form submission
    document.getElementById('event-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formAction = document.getElementById('form-action').value;
        const events = loadData('events');
        
        const eventData = {
            title: document.getElementById('title').value.trim(),
            date: document.getElementById('date').value.trim(),
            time: document.getElementById('time').value.trim(),
            location: document.getElementById('location').value.trim(),
            description: document.getElementById('description').value.trim()
        };
        
        if (formAction === 'add') {
            eventData.id = generateId();
            events.push(eventData);
            showMessage('Event added successfully!', 'success');
        } else {
            const editId = document.getElementById('form-id').value;
            const index = events.findIndex(e => e.id === editId);
            if (index !== -1) {
                eventData.id = editId;
                events[index] = eventData;
                showMessage('Event updated successfully!', 'success');
            }
        }
        
        saveData('events', events);
        renderEvents();
        
        // Reset form and hide
        document.getElementById('event-form').reset();
        document.getElementById('event-form-section').style.display = 'none';
        document.getElementById('actions-bar').style.display = 'block';
        window.history.pushState({}, '', 'events.html');
    });

    // Initial render
    renderEvents();
</script>
</body>
</html>

