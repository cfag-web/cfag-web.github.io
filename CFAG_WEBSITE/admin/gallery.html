<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Manage Gallery | Admin</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="assets/css/admin.css">
    <style>
        .gallery-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        .gallery-preview-item {
            position: relative;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            background: #f9f9f9;
        }
        .gallery-preview-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }
        .gallery-preview-item .preview-info {
            padding: 0.75rem;
            background: white;
        }
        .gallery-preview-item .preview-info p {
            margin: 0.25rem 0;
            font-size: 0.9rem;
            color: #666;
        }
        .gallery-preview-item .preview-actions {
            padding: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }
        .image-upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s;
        }
        .image-upload-area:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }
        .image-upload-area.dragover {
            border-color: #667eea;
            background: #e8e8ff;
        }
        .image-upload-area input[type="file"] {
            display: none;
        }
        .preview-thumbnail {
            max-width: 100%;
            max-height: 150px;
            margin: 0.5rem 0;
            border-radius: 4px;
        }
    </style>
</head>
<body class="admin-body">
<header class="admin-header">
    <div class="container">
        <div class="admin-header-inner">
            <div class="admin-logo">
                <a href="index.html">CFAG Admin</a>
            </div>
            <nav class="admin-nav">
                <a href="index.html">Dashboard</a>
                <a href="events.html">Events</a>
                <a href="sermons.html">Sermons</a>
                <a href="ministries.html">Ministries</a>
                <a href="gallery.html" class="active">Gallery</a>
                <a href="../index.html" target="_blank">View Site</a>
                <a href="logout.html">Logout</a>
            </nav>
        </div>
    </div>
</header>
<main class="admin-main">
    <div class="container">

<h1>Manage Gallery</h1>

<div id="admin-message" class="alert hidden" style="display: none;"></div>

<section class="admin-form-section" id="image-form-section" style="display: none;">
    <h2 id="form-title">Add New Image</h2>
    <form id="image-form" class="form">
        <input type="hidden" name="action" id="form-action" value="add">
        <input type="hidden" name="id" id="form-id">
        <input type="hidden" name="image_data" id="image_data">
        <input type="hidden" name="thumbnail_data" id="thumbnail_data">
        
        <div class="form-row">
            <label>Upload Image *</label>
            <div class="image-upload-area" id="upload-area">
                <p>ðŸ“· Click here or drag and drop an image</p>
                <p style="font-size: 0.9rem; color: #666;">Supports: JPG, PNG, GIF (Max: 5MB)</p>
                <input type="file" id="image_file" name="image_file" accept="image/*" required>
                <div id="image-preview" style="display: none; margin-top: 1rem;">
                    <img id="preview-img" class="preview-thumbnail" alt="Preview">
                </div>
            </div>
        </div>
        
        <div class="form-row">
            <label for="alt_text">Image Alt Text / Description *</label>
            <input type="text" id="alt_text" name="alt_text" placeholder="e.g., Worship service" required>
            <small>This text describes the image for accessibility and SEO</small>
        </div>
        
        <div class="form-row">
            <button type="submit" class="btn btn-primary" id="submit-btn">Add Image</button>
            <a href="gallery.html" class="btn btn-outline">Cancel</a>
        </div>
    </form>
</section>

<div class="admin-actions-bar" id="actions-bar">
    <a href="gallery.html?action=add" class="btn btn-primary">âž• Add New Image</a>
</div>

<section class="admin-section">
    <h2>Gallery Images (<span id="gallery-count">0</span>)</h2>
    
    <div id="no-images-message" style="display: none;">
        <p>No images yet. <a href="gallery.html?action=add">Add your first image</a>.</p>
    </div>
    
    <div class="gallery-preview-grid" id="gallery-grid" style="display: none;">
    </div>
</section>

    </div>
</main>
<script src="../assets/js/main.js"></script>
<script src="assets/js/admin.js"></script>
<script>
    // Check authentication
    if (localStorage.getItem('admin_logged_in') !== 'true') {
        window.location.href = 'login.html';
    }

    function loadData(type) {
        const stored = localStorage.getItem('admin_' + type);
        if (stored) {
            return JSON.parse(stored);
        }
        return [];
    }

    function saveData(type, data) {
        localStorage.setItem('admin_' + type, JSON.stringify(data));
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function showMessage(text, type) {
        const msgDiv = document.getElementById('admin-message');
        msgDiv.textContent = text;
        msgDiv.className = 'alert ' + type;
        msgDiv.style.display = 'block';
        setTimeout(() => {
            msgDiv.style.display = 'none';
        }, 5000);
    }

    function createThumbnail(imageData, maxWidth = 300) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                let width = img.width;
                let height = img.height;
                
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                resolve(canvas.toDataURL('image/jpeg', 0.8));
            };
            img.src = imageData;
        });
    }

    function renderGallery() {
        const images = loadData('gallery');
        
        document.getElementById('gallery-count').textContent = images.length;
        
        const grid = document.getElementById('gallery-grid');
        grid.innerHTML = '';
        
        if (images.length === 0) {
            document.getElementById('no-images-message').style.display = 'block';
            document.getElementById('gallery-grid').style.display = 'none';
        } else {
            document.getElementById('no-images-message').style.display = 'none';
            document.getElementById('gallery-grid').style.display = 'grid';
            
            images.forEach(image => {
                const item = document.createElement('div');
                item.className = 'gallery-preview-item';
                item.innerHTML = `
                    <img src="${escapeHtml(image.thumbnail || image.image_data)}" alt="${escapeHtml(image.alt_text)}">
                    <div class="preview-info">
                        <p><strong>${escapeHtml(image.alt_text)}</strong></p>
                        <p style="font-size: 0.8rem; color: #999;">Added: ${new Date(image.id).toLocaleDateString()}</p>
                    </div>
                    <div class="preview-actions">
                        <a href="gallery.html?action=edit&id=${escapeHtml(image.id)}" class="btn btn-outline btn-small">Edit</a>
                        <a href="#" class="btn btn-outline btn-small btn-danger" onclick="deleteImage('${escapeHtml(image.id)}')">Delete</a>
                    </div>
                `;
                grid.appendChild(item);
            });
        }
    }

    function deleteImage(id) {
        if (!confirm('Are you sure you want to delete this image?')) {
            return;
        }
        
        const images = loadData('gallery');
        const filtered = images.filter(img => img.id !== id);
        saveData('gallery', filtered);
        showMessage('Image deleted successfully!', 'success');
        renderGallery();
    }

    window.deleteImage = deleteImage;

    // Handle URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const action = urlParams.get('action');
    const id = urlParams.get('id');

    if (action === 'add' || (action === 'edit' && id)) {
        document.getElementById('image-form-section').style.display = 'block';
        document.getElementById('actions-bar').style.display = 'none';
        
        if (action === 'edit' && id) {
            const images = loadData('gallery');
            const image = images.find(img => img.id === id);
            if (image) {
                document.getElementById('form-title').textContent = 'Edit Image';
                document.getElementById('form-action').value = 'edit';
                document.getElementById('form-id').value = image.id;
                document.getElementById('alt_text').value = image.alt_text || '';
                document.getElementById('image_data').value = image.image_data || '';
                document.getElementById('thumbnail_data').value = image.thumbnail || '';
                document.getElementById('submit-btn').textContent = 'Update Image';
                
                if (image.image_data) {
                    document.getElementById('image-preview').style.display = 'block';
                    document.getElementById('preview-img').src = image.image_data;
                }
            }
        }
    }

    // File upload handling
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('image_file');
    const previewDiv = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');

    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect(files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });

    function handleFileSelect(file) {
        if (!file.type.startsWith('image/')) {
            showMessage('Please select an image file.', 'error');
            return;
        }

        if (file.size > 5 * 1024 * 1024) {
            showMessage('Image size must be less than 5MB.', 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = async function(e) {
            const imageData = e.target.result;
            previewImg.src = imageData;
            previewDiv.style.display = 'block';
            
            // Create thumbnail
            const thumbnail = await createThumbnail(imageData);
            document.getElementById('image_data').value = imageData;
            document.getElementById('thumbnail_data').value = thumbnail;
        };
        reader.readAsDataURL(file);
    }

    // Handle form submission
    document.getElementById('image-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formAction = document.getElementById('form-action').value;
        const images = loadData('gallery');
        
        const imageData = document.getElementById('image_data').value;
        const thumbnailData = document.getElementById('thumbnail_data').value;
        const altText = document.getElementById('alt_text').value.trim();
        
        if (!imageData || !altText) {
            showMessage('Please upload an image and provide alt text.', 'error');
            return;
        }
        
        const imageObj = {
            image_data: imageData,
            thumbnail: thumbnailData || imageData,
            alt_text: altText
        };
        
        if (formAction === 'add') {
            imageObj.id = generateId();
            images.push(imageObj);
            showMessage('Image added successfully!', 'success');
        } else {
            const editId = document.getElementById('form-id').value;
            const index = images.findIndex(img => img.id === editId);
            if (index !== -1) {
                imageObj.id = editId;
                images[index] = imageObj;
                showMessage('Image updated successfully!', 'success');
            }
        }
        
        saveData('gallery', images);
        renderGallery();
        
        // Reset form and hide
        document.getElementById('image-form').reset();
        previewDiv.style.display = 'none';
        document.getElementById('image-form-section').style.display = 'none';
        document.getElementById('actions-bar').style.display = 'block';
        window.history.pushState({}, '', 'gallery.html');
    });

    // Initial render
    renderGallery();
</script>
</body>
</html>

